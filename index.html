<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>中国万亿GDP城市 - 六车道版</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #2E7D32; 
            /* 使用系统默认字体栈，保证清晰度 */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        #canvas-container {
            width: 100%;
            height: 100vh;
            position: relative;
            background-color: #333; 
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* --- UI 层 --- */
        #ui-layer {
            position: absolute;
            top: 5vh;
            width: 100%;
            text-align: center;
            color: #fff;
            pointer-events: none;
            z-index: 100;
        }
        #year-display {
            font-family: 'Press Start 2P', cursive;
            font-size: 28px;
            margin-bottom: 6px;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            letter-spacing: 2px;
        }
        #info-bar {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: rgba(0,0,0,0.6);
            padding: 4px 12px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.4);
            backdrop-filter: blur(4px);
        }
        .label-text {
            font-weight: 700;
            font-size: 16px;
            color: #fff;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }
        #count-display {
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            color: #333;
            background: #FFEB3B;
            padding: 4px 8px;
            border-radius: 4px;
            box-shadow: 1px 1px 0 #F57F17;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
        }
        .unit-text {
            font-weight: 700;
            font-size: 12px;
            margin-left: 3px;
            color: #333;
        }

        /* --- 底部控制栏 --- */
        #controls-bar {
            position: absolute;
            bottom: 4vh;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 200;
            pointer-events: auto; 
        }

        .pixel-btn {
            font-weight: 700;
            font-size: 16px;
            color: #fff;
            background: #333;
            border: 2px solid #fff;
            padding: 8px 24px;
            cursor: pointer;
            box-shadow: 2px 2px 0 #000;
            text-shadow: 0 1px 0 rgba(0,0,0,0.5);
            transition: transform 0.1s, box-shadow 0.1s, background-color 0.3s;
            min-width: 80px;
            border-radius: 8px;
        }

        .pixel-btn:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 #000;
        }

        .btn-replay-mode { background-color: #D32F2F !important; }
        .btn-resume-mode { background-color: #388E3C !important; }
        #btn-share { background: #1976D2; }

        #toast {
            position: absolute;
            bottom: 12vh;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: #FFEB3B;
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid #fff;
            font-weight: 700;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 300;
            white-space: nowrap;
        }
        #toast.show { opacity: 1; }

    </style>
</head>
<body>

<div id="ui-layer">
    <div id="year-display">2006</div>
    <div id="info-bar">
        <span class="label-text">万亿GDP城市</span>
        <div id="count-display">
            <span id="count-num">1</span><span class="unit-text">个</span>
        </div>
    </div>
</div>

<div id="controls-bar">
    <button id="btn-toggle" class="pixel-btn">暂停</button>
    <button id="btn-share" class="pixel-btn">分享</button>
</div>

<div id="toast">已复制链接!</div>

<div id="canvas-container">
    <canvas id="gameCanvas"></canvas>
</div>

<script>
    const timeline = {
        2006: ["上海"], 2007: ["北京"], 2010: ["广州"], 
        2011: ["深圳", "重庆", "苏州"], 2013: ["天津"], 
        2014: ["武汉", "成都"], 2015: ["杭州"],
        2016: ["南京", "青岛"], 2017: ["长沙", "无锡"], 
        2018: ["宁波", "郑州"], 2019: ["佛山"], 
        2020: ["泉州", "济南", "合肥", "南通", "福州", "西安"],
        2021: ["东莞"], 2023: ["常州", "烟台"],
        2024: ["唐山"], 2025: ["温州", "大连"]
    };
    
    const activeYears = Object.keys(timeline).map(Number).sort((a,b)=>a-b);
    const yearColors = ['#F44336', '#2196F3', '#4CAF50', '#FFC107', '#9C27B0', '#FF5722', '#00BCD4', '#E91E63'];

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const yearText = document.getElementById('year-display');
    const countNum = document.getElementById('count-num');
    const btnToggle = document.getElementById('btn-toggle');
    const btnShare = document.getElementById('btn-share');
    const toast = document.getElementById('toast');
    const container = document.getElementById('canvas-container');

    let w, h, dpr;
    let roadScroll = 0;
    const ROAD_SPEED = 8; 

    let cars = [];
    let currentYearIndex = 0;
    let currentYear = activeYears[0];
    let yearTimer = 0;
    const YEAR_DURATION = 2500; 
    
    // 【关键修改】改为6车道
    const LANE_COUNT = 6; 
    
    let laneWidth, roadLeft, roadW;
    let carWidth, carHeight, fontSize; 
    let cameraScale = 1;
    let contentHeight = 0;
    
    let isPaused = false;
    let isFinished = false;

    class Car {
        constructor(name, foundYear, index) {
            this.name = name;
            this.foundYear = foundYear;
            this.originalIndex = index;
            this.mainColor = yearColors[foundYear % yearColors.length];
            
            this.width = 0;
            this.height = 0;
            this.x = 0;
            this.y = 0; 
            
            this.targetX = 0;
            this.targetY = 0;
            this.driftPhase = Math.random() * Math.PI * 2;
            this.hasSpawned = false;
        }

        update(localRankIndex, isNew, startY) {
            this.width = carWidth;
            this.height = carHeight;

            const row = Math.floor(localRankIndex / LANE_COUNT); 
            const col = localRankIndex % LANE_COUNT;
            
            this.targetX = roadLeft + col * laneWidth + (laneWidth - this.width) / 2;

            const rowGap = this.height * 1.7; 
            this.targetY = startY + row * rowGap;

            if (this.targetY + this.height > contentHeight) {
                contentHeight = this.targetY + this.height;
            }

            if (!this.hasSpawned) {
                this.x = this.targetX; 
                this.y = this.targetY + (h / cameraScale) + 400; 
                this.hasSpawned = true;
            }

            this.x += (this.targetX - this.x) * 0.1;
            this.y += (this.targetY - this.y) * 0.08;
            this.currentDrift = Math.sin(Date.now() / 250 + this.driftPhase) * 2;
        }

        draw(ctx) {
            const x = this.x + this.currentDrift;
            const y = this.y;
            // 阴影
            ctx.fillStyle = "rgba(0,0,0,0.4)";
            ctx.fillRect(x + this.width*0.15, y + this.width*0.15, this.width, this.height);
            
            // 轮胎
            ctx.fillStyle = "#111";
            const wW = this.width * 0.18; 
            const wH = this.height * 0.22; 
            ctx.fillRect(x - wW/2, y + wH/2, wW, wH); 
            ctx.fillRect(x + this.width - wW/2, y + wH/2, wW, wH);
            ctx.fillRect(x - wW/2, y + this.height - wH*1.5, wW, wH); 
            ctx.fillRect(x + this.width - wW/2, y + this.height - wH*1.5, wW, wH);
            
            // 车身
            ctx.fillStyle = this.mainColor;
            ctx.fillRect(x, y, this.width, this.height);
            // 玻璃
            ctx.fillStyle = "#283593";
            ctx.fillRect(x + this.width*0.1, y + this.height*0.18, this.width*0.8, this.height*0.2);
            // 尾翼
            ctx.fillStyle = "rgba(0,0,0,0.25)";
            ctx.fillRect(x + this.width*0.05, y + this.height*0.82, this.width*0.9, this.height*0.12);
            // 文字
            this.drawBodyText(ctx, x, y);
        }

        drawBodyText(ctx, x, y) {
            ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillStyle = "#fff";
            ctx.shadowColor = "rgba(0,0,0,0.3)";
            ctx.shadowBlur = 0; ctx.shadowOffsetX = 1; ctx.shadowOffsetY = 1;
            
            const textYStart = y + this.height * 0.52;
            const textGap = fontSize * 1.1;

            ctx.fillText(this.name[0], x + this.width/2, textYStart);
            if (this.name[1]) ctx.fillText(this.name[1], x + this.width/2, textYStart + textGap);
            ctx.shadowColor = "transparent";
        }
    }

    function resize() {
        dpr = window.devicePixelRatio || 1;
        const rect = container.getBoundingClientRect();
        w = rect.width;
        h = rect.height;

        canvas.width = w * dpr;
        canvas.height = h * dpr;
        ctx.resetTransform();
        ctx.scale(dpr, dpr);

        // 【关键修改】赛道更宽：98% 屏幕宽度，挤满屏幕
        const maxRoadWidth = 800; // 平板上限调大
        roadW = Math.min(w * 0.98, maxRoadWidth);
        roadLeft = (w - roadW) / 2;
        laneWidth = roadW / LANE_COUNT;

        // 【关键修改】车身占比：因为车道变窄，车身占比提升到 0.65，防止车太小
        carWidth = laneWidth * 0.65; 
        carHeight = carWidth * 1.6;
        
        fontSize = Math.floor(carWidth * 0.45);
    }
    window.addEventListener('resize', resize);

    function drawRoad() {
        const drawH = (h / cameraScale) + 600; 

        ctx.fillStyle = "#555";
        ctx.fillRect(roadLeft, 0, roadW, drawH);

        if (!isPaused && !isFinished) {
            roadScroll = (roadScroll + ROAD_SPEED) % 80;
        }

        ctx.fillStyle = "#EEE"; 
        const borderW = roadW * 0.02; // 路肩再细一点
        ctx.fillRect(roadLeft - borderW, 0, borderW, drawH); 
        ctx.fillRect(roadLeft + roadW, 0, borderW, drawH);   

        ctx.fillStyle = "rgba(255,255,255,0.4)"; 
        for(let i=1; i<LANE_COUNT; i++) {
            let lx = roadLeft + i * laneWidth;
            for(let y = -80; y < drawH; y += 80) {
                ctx.fillRect(lx - 2, y + roadScroll, 4, 40);
            }
        }
    }

    function drawSeparator(ctx, y) {
        ctx.save();
        ctx.translate(w/2, y);
        
        const currentColor = yearColors[currentYear % yearColors.length];

        ctx.beginPath();
        ctx.setLineDash([10, 10]);
        ctx.moveTo(-roadW * 0.45, 0);
        ctx.lineTo(roadW * 0.45, 0);
        ctx.strokeStyle = currentColor; 
        ctx.lineWidth = 4;
        ctx.stroke();

        ctx.fillStyle = currentColor; 
        const labelW = fontSize * 7; 
        const labelH = fontSize * 1.8;  
        ctx.fillRect(-labelW/2, -labelH/2, labelW, labelH);

        ctx.font = `bold ${fontSize}px sans-serif`; 
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.shadowColor = "rgba(0,0,0,0.3)";
        ctx.shadowBlur = 0; ctx.shadowOffsetX = 1; ctx.shadowOffsetY = 1;
        
        ctx.fillStyle = "#fff"; 
        ctx.fillText(currentYear + "年新增", 0, 2);
        ctx.restore();
    }

    function gameLoop() {
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        ctx.clearRect(0, 0, w, h);

        contentHeight = 0;
        
        const topMargin = h * 0.22; 
        const rowGap = carHeight * 1.7;
        const groupGap = rowGap * 1.2; 
        const bottomPadding = h * 0.25; 

        const oldCars = cars.filter(c => c.foundYear < currentYear);
        const newCars = cars.filter(c => c.foundYear === currentYear);

        const oldRows = Math.ceil(Math.max(oldCars.length, 0) / LANE_COUNT);
        const newRows = Math.ceil(Math.max(newCars.length, 0) / LANE_COUNT);
        
        let newCarsStartY = topMargin;
        if (oldCars.length > 0) {
            newCarsStartY = topMargin + oldRows * rowGap + groupGap;
        }

        let totalH = newCarsStartY;
        if (newCars.length > 0) {
            totalH += (newRows - 1) * rowGap + carHeight; 
        } else if (oldCars.length > 0) {
            totalH = topMargin + (oldRows - 1) * rowGap + carHeight;
        }
        totalH += bottomPadding;

        let targetScale = totalH > h ? h / totalH : 1;
        targetScale = Math.max(targetScale, 0.4); 
        cameraScale += (targetScale - cameraScale) * 0.1;

        const centerX = w / 2;
        ctx.translate(centerX, 0);
        ctx.scale(cameraScale, cameraScale);
        ctx.translate(-centerX, 0);

        drawRoad();

        if (!isPaused && !isFinished) {
            yearTimer += 16;
            if (yearTimer > YEAR_DURATION) {
                if (currentYearIndex < activeYears.length - 1) {
                    yearTimer = 0;
                    currentYearIndex++;
                    currentYear = activeYears[currentYearIndex];
                    updateYearDisplay();
                } else {
                     if (yearTimer > YEAR_DURATION + 500) {
                         isFinished = true;
                         setReplayMode();
                     }
                }
            }
        }

        oldCars.sort((a, b) => a.foundYear - b.foundYear || a.originalIndex - b.originalIndex);
        oldCars.forEach((car, i) => {
            car.update(i, false, topMargin);
            car.draw(ctx);
        });

        if (newCars.length > 0 && oldCars.length > 0) {
            let lineY = topMargin + oldRows * rowGap + groupGap / 2 - (groupGap * 0.2);
            drawSeparator(ctx, lineY);
        }

        newCars.sort((a, b) => a.originalIndex - b.originalIndex);
        newCars.forEach((car, i) => {
            let startY = (oldCars.length === 0) ? topMargin : newCarsStartY;
            car.update(i, true, startY);
            car.draw(ctx);
        });

        requestAnimationFrame(gameLoop);
    }

    function updateYearDisplay() {
        yearText.innerText = currentYear;
        yearText.style.transform = "scale(1.2)";
        setTimeout(()=> yearText.style.transform = "scale(1)", 150);

        if (timeline[currentYear]) {
            timeline[currentYear].forEach(name => {
                cars.push(new Car(name, currentYear, cars.length));
            });
            countNum.innerText = cars.length;
        }
    }

    function setReplayMode() {
        btnToggle.innerText = "重播";
        btnToggle.classList.remove('btn-resume-mode');
        btnToggle.classList.add('btn-replay-mode'); 
    }

    function resetGame() {
        cars = [];
        currentYearIndex = 0;
        currentYear = activeYears[0]; 
        yearTimer = 0; 
        isPaused = false;
        isFinished = false;
        cameraScale = 1;
        
        yearText.innerText = currentYear;
        countNum.innerText = "1"; 
        btnToggle.innerText = "暂停";
        btnToggle.classList.remove('btn-replay-mode');
        btnToggle.classList.remove('btn-resume-mode');
        
        timeline[currentYear].forEach(name => {
            cars.push(new Car(name, currentYear, cars.length));
        });
    }

    btnToggle.addEventListener('click', () => {
        if (isFinished) {
            resetGame();
        } else {
            isPaused = !isPaused;
            if (isPaused) {
                btnToggle.innerText = "继续";
                btnToggle.classList.add('btn-resume-mode');
            } else {
                btnToggle.innerText = "暂停";
                btnToggle.classList.remove('btn-resume-mode');
            }
        }
    });

    btnShare.addEventListener('click', () => {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }).catch(err => {
            alert("复制失败，请手动复制链接");
        });
    });

    resize();
    currentYearIndex = 0;
    currentYear = activeYears[0];
    timeline[currentYear].forEach(name => {
        cars.push(new Car(name, currentYear, cars.length));
    });
    countNum.innerText = cars.length;
    
    requestAnimationFrame(gameLoop);

</script>
</body>
</html>
