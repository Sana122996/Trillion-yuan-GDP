<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‰∏≠ÂõΩ‰∏á‰∫øGDPÂüéÂ∏Ç - ÂÆåÁæéÂ§ßÁªìÂ±Ä</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <style>
        /* --- 1. Âü∫Á°ÄÊ†∑Âºè --- */
        body { 
            margin: 0; overflow: hidden; background: #111; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            touch-action: none; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- 2. ËàûÂè∞ÂÆπÂô® --- */
        #stage-container {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            background: #333; overflow: hidden;
        }

        /* --- 3. Ê∏∏ÊàèÊ†∏ÂøÉ --- */
        #game-stage {
            position: relative;
            width: 750px; height: 1500px; 
            background: #2E7D32; 
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* --- 4. ÂπΩÁÅµÁÇπÂáªÂ±Ç --- */
        #hitbox-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 50;
        }
        .car-hitbox {
            position: absolute; background: transparent; cursor: pointer;
            pointer-events: auto; z-index: 51;
        }

        /* --- 5. UI Â±Ç --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 100;
            display: flex; flex-direction: column; justify-content: space-between;
            /* È°∂ÈÉ®ÁïôÁôΩÂ¢ûÂä†ÔºåÂ∫ïÈÉ®ÁïôÁôΩÂ¢ûÂä† */
            padding: 50px 20px 40px 20px; box-sizing: border-box;
        }
        .top-bar { text-align: center; color: #fff; transform-origin: top center; transform: scale(1.1); }
        #year-display { 
            font-family: 'Press Start 2P', cursive;
            font-size: 36px; margin-bottom: 10px; 
            text-shadow: 3px 3px 0 #000;
        }
        #info-pill { 
            background: rgba(0,0,0,0.6); display: inline-flex; align-items: center; 
            padding: 8px 20px; border-radius: 40px; border: 2px solid rgba(255,255,255,0.5); font-size: 16px; font-weight: bold;
        }
        #count-num { color: #FFEB3B; font-family: 'Press Start 2P'; margin: 0 5px; font-size: 18px; }

        .bottom-bar { 
            display: flex; justify-content: center; gap: 20px; 
            pointer-events: none; padding-bottom: 30px;
        }
        .pixel-btn {
            pointer-events: auto; 
            font-weight: 900; font-size: 18px; color: #fff; background: #333;
            border: 3px solid #fff; padding: 15px 35px;
            box-shadow: 4px 4px 0 #000; border-radius: 10px;
            cursor: pointer;
        }
        .pixel-btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0 #000; }
        
        #btn-share { background: #FFEB3B; color: #333; border-color: #fff; }
        .btn-replay { background: #D32F2F !important; animation: pulseBtn 1s infinite; }
        @keyframes pulseBtn { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }

        /* --- 6. ÂºπÁ™ó (Á≤æ‰øÆÁâà) --- */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        #modal-box {
            width: 90%; max-width: 600px; height: 55vh;
            background: #fff; 
            border-radius: 20px; overflow: hidden;
            display: flex; flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from {transform: scale(0.9); opacity: 0;} to {transform: scale(1); opacity: 1;} }

        #modal-header {
            background: linear-gradient(135deg, #FFEB3B, #FDD835); 
            color: #333; padding: 15px 20px;
            text-align: center; position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 10;
        }
        #m-title { font-size: 18px; font-weight: 900; display: block; margin-bottom: 4px; }
        #m-subtitle { font-size: 12px; color: #555; font-weight: normal; opacity: 0.8; }
        
        #modal-close {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            font-size: 32px; cursor: pointer; padding: 10px; font-weight: 300; color: #333;
            line-height: 1;
        }
        #chart-container { flex: 1; position: relative; width: 100%; overflow: hidden; background: #fff; }
        #echarts-dom { width: 100%; height: 100%; }

        /* --- 7. Toast --- */
        #toast {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); color: #FFEB3B; padding: 15px 30px;
            border: 2px solid #fff; font-size: 16px; font-weight: bold;
            z-index: 3000; display: none; text-align: center; border-radius: 8px;
            pointer-events: none; white-space: nowrap;
        }
    </style>
</head>
<body>

<div id="stage-container">
    <div id="game-stage">
        <canvas id="main-canvas" width="750" height="1500"></canvas>
        <div id="hitbox-layer"></div>
        
        <div id="ui-layer">
            <div class="top-bar">
                <div id="year-display">2006</div>
                <div id="info-pill">
                    <span>‰∏á‰∫øÂüéÂ∏Ç</span><span id="count-num">1</span><span>‰∏™</span>
                </div>
            </div>
            <div class="bottom-bar">
                <button id="btn-toggle" class="pixel-btn">ÊöÇÂÅú</button>
                <button id="btn-share" class="pixel-btn">ÂàÜ‰∫´</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-overlay">
    <div id="modal-box">
        <div id="modal-header">
            <span id="m-title">‰∏äÊµ∑ GDPÂèòÂåñ</span>
            <span id="m-subtitle">Âçï‰ΩçÔºö‰∫øÂÖÉ‰∫∫Ê∞ëÂ∏Å</span>
            <div id="modal-close">√ó</div>
        </div>
        <div id="chart-container">
            <div id="echarts-dom"></div>
        </div>
    </div>
</div>

<div id="toast"></div>

<script>
    // --- 1. Êï∞ÊçÆÊ∫ê ---
    const gdpData = {
        "‰∏äÊµ∑": {2025:56709,2024:53927,2023:51405,2022:48595,2021:47059,2020:41604,2019:40241,2018:37769,2017:34378,2016:30964,2015:27822,2014:25965,2013:23809,2012:21775,2011:20406,2010:18320,2009:16181,2008:14877,2007:13180,2006:10825},
        "Âåó‰∫¨": {2025:52073,2024:49843,2023:47354,2022:45222,2021:44351,2020:38504,2019:37767,2018:35161,2017:31326,2016:28439,2015:26034,2014:23578,2013:21746,2012:19568,2011:17653,2010:15420,2009:13336,2008:12168,2007:10730,2006:8619},
        "ÂπøÂ∑û": {2025:32039,2024:31033,2023:30356,2022:28839,2021:28232,2020:25019,2019:23629,2018:22859,2017:21503,2016:19547,2015:18100,2014:16707,2013:15420,2012:13551,2011:12423,2010:10748,2009:9138,2008:8216,2007:7109,2006:6074},
        "Ê∑±Âú≥": {2025:38732,2024:36802,2023:34606,2022:32388,2021:30665,2020:27670,2019:26927,2018:24222,2017:22490,2016:19493,2015:17503,2014:16002,2013:14500,2012:12950,2011:11506,2010:9582,2009:8201,2008:7807,2007:6802,2006:5814},
        "ÈáçÂ∫Ü": {2025:33758,2024:32193,2023:30614,2022:28772,2021:28093,2020:25158,2019:23690,2018:21867,2017:20261,2016:18271,2015:16306,2014:14912,2013:13276,2012:11798,2011:10314,2010:8187,2009:6744,2008:5979,2007:4838,2006:3949},
        "ËãèÂ∑û": {2025:27695,2024:26727,2023:24653,2022:23958,2021:22718,2020:20170,2019:19236,2018:18597,2017:16997,2016:15445,2015:14469,2014:13717,2013:12930,2012:11966,2011:10670,2010:9181,2009:7851,2008:7163,2007:5914,2006:4948},
        "Â§©Ê¥•": {2025:18540,2024:18024,2023:17212,2022:16589,2021:16093,2020:14231,2019:14097,2018:13411,2017:12468,2016:11487,2015:10889,2014:10749,2013:10075,2012:9193,2011:8241,2010:6992,2009:5829,2008:5278,2007:4230,2006:3593},
        "Ê≠¶Ê±â": {2025:22147,2024:21106,2023:20012,2022:18866,2021:17717,2020:15616,2019:16223,2018:14847,2017:13410,2016:11913,2015:10906,2014:10069,2013:9051,2012:8004,2011:6762,2010:5566,2009:4621,2008:3960,2007:3142,2006:2591},
        "ÊàêÈÉΩ": {2025:24764,2024:23511,2023:22075,2022:20818,2021:19917,2020:17717,2019:17013,2018:15343,2017:13889,2016:12170,2015:10801,2014:10057,2013:9109,2012:8139,2011:6855,2010:5551,2009:4503,2008:3901,2007:3324,2006:2750},
        "Êù≠Â∑û": {2025:23011,2024:21860,2023:20059,2022:18753,2021:18109,2020:16106,2019:15373,2018:13509,2017:12603,2016:11314,2015:10050,2014:9206,2013:8344,2012:7802,2011:7019,2010:5949,2009:5088,2008:4781,2007:4130,2006:3442},
        "Âçó‰∫¨": {2025:19429,2024:18501,2023:17421,2022:16908,2021:16356,2020:14818,2019:14031,2018:12820,2017:11715,2016:10503,2015:9721,2014:8821,2013:8012,2012:7202,2011:6146,2010:5131,2009:4230,2008:3775,2007:3284,2006:2774},
        "ÈùíÂ≤õ": {2025:17561,2024:16719,2023:15760,2022:14921,2021:14136,2020:12401,2019:11741,2018:12002,2017:11037,2016:10011,2015:9300,2014:8692,2013:8007,2012:7302,2011:6616,2010:5666,2009:4854,2008:4436,2007:3787,2006:3207},
        "Êó†Èî°": {2025:16774,2024:16263,2023:15456,2022:14851,2021:14003,2020:12370,2019:11852,2018:11439,2017:10511,2016:9340,2015:8681,2014:8359,2013:7920,2012:7446,2011:6800,2010:5779,2009:5027,2008:4530,2007:3932,2006:3350},
        "ÈïøÊ≤ô": {2025:15738,2024:15269,2023:14332,2022:13966,2021:13271,2020:12143,2019:11574,2018:11003,2017:10536,2016:9357,2015:8510,2014:7825,2013:7153,2012:6400,2011:5619,2010:4547,2009:3745,2008:3001,2007:2190,2006:1799},
        "ÂÆÅÊ≥¢": {2025:18716,2024:18148,2023:16453,2022:15704,2021:14595,2020:12409,2019:11985,2018:10745,2017:9842,2016:8686,2015:8004,2014:7610,2013:7129,2012:6582,2011:6059,2010:5163,2009:4329,2008:3964,2007:3435,2006:2874},
        "ÈÉëÂ∑û": {2025:15245,2024:14532,2023:13618,2022:12935,2021:12691,2020:12004,2019:11590,2018:10143,2017:9130,2016:8114,2015:7312,2014:6777,2013:6202,2012:5550,2011:4980,2010:4041,2009:3308,2008:3004,2007:2487,2006:2013},
        "‰ΩõÂ±±": {2025:13200,2024:13362,2023:13276,2022:12698,2021:12157,2020:10816,2019:10751,2018:9936,2017:9382,2016:8756,2015:8108,2014:7510,2013:7064,2012:6643,2011:6231,2010:5665,2009:4843,2008:4419,2007:3696,2006:3021},
        "Á¶èÂ∑û": {2025:15112,2024:14237,2023:12928,2022:12308,2021:11324,2020:10020,2019:9392,2018:7857,2017:7103,2016:6198,2015:5618,2014:5169,2013:4679,2012:4218,2011:3736,2010:3123,2009:2604,2008:2284,2007:1975,2006:1664},
        "Ê≥âÂ∑û": {2025:13778,2024:13095,2023:12172,2022:12103,2021:11304,2020:10159,2019:9947,2018:8468,2017:7940,2016:6921,2015:6321,2014:5954,2013:5380,2012:4814,2011:4282,2010:3673,2009:3133,2008:2789,2007:2355,2006:1875},
        "ÂçóÈÄö": {2025:12802,2024:12422,2023:11813,2022:11309,2021:10947,2020:10018,2019:9369,2018:8753,2017:8034,2016:7152,2015:6498,2014:5749,2013:5235,2012:4630,2011:4139,2010:3511,2009:2904,2008:2620,2007:2182,2006:1802},
        "ÂêàËÇ•": {2025:14210,2024:13508,2023:12674,2022:12013,2021:11413,2020:10046,2019:9409,2018:7823,2017:7213,2016:6274,2015:5660,2014:5158,2013:4673,2012:4164,2011:3637,2010:2702,2009:2102,2008:1665,2007:1335,2006:1074},
        "Ë•øÂÆâ": {2025:13903,2024:13318,2023:12011,2022:11487,2021:10688,2020:10020,2019:9321,2018:8350,2017:7470,2016:6257,2015:5801,2014:5493,2013:4884,2012:4366,2011:3864,2010:3242,2009:2724,2008:2190,2007:1764,2006:1474},
        "ÊµéÂçó": {2025:14210,2024:13528,2023:12757,2022:12027,2021:11432,2020:10141,2019:9443,2018:7857,2017:7202,2016:6536,2015:6100,2014:5771,2013:5230,2012:4804,2011:4406,2010:3911,2009:3351,2008:3017,2007:2563,2006:2185},
        "‰∏úËéû": {2025:12760,2024:12282,2023:11870,2022:11743,2021:11273,2020:10080,2019:9737,2018:9022,2017:8079,2016:7261,2015:6665,2014:6175,2013:5740,2012:5190,2011:4887,2010:4340,2009:3817,2008:3716,2007:3169,2006:2636},
        "Â∏∏Â∑û": {2025:11159,2024:10814,2023:10116,2022:9552,2021:9038,2020:7810,2019:7406,2018:6897,2017:6478,2016:5752,2015:5281,2014:4991,2013:4528,2012:4040,2011:3640,2010:3092,2009:2561,2008:2302,2007:1937,2006:1604},
        "ÁÉüÂè∞": {2025:11351,2024:10783,2023:10162,2022:9516,2021:8712,2020:7816,2019:7653,2018:7833,2017:6762,2016:6456,2015:6086,2014:5705,2013:5338,2012:5009,2011:4621,2010:4086,2009:3676,2008:3409,2007:2880,2006:2406},
        "ÂîêÂ±±": {2025:10482,2024:10004,2023:9133,2022:8901,2021:8231,2020:7211,2019:6890,2018:6300,2017:5917,2016:5602,2015:5118,2014:5086,2013:4937,2012:4716,2011:5442,2010:4469,2009:3813,2008:3537,2007:2779,2006:2336},
        "Ê∏©Â∑û": {2025:10214,2024:9719,2023:8731,2022:8030,2021:7585,2020:6871,2019:6606,2018:6006,2017:5412,2016:5125,2015:4670,2014:4351,2013:4068,2012:3707,2011:3437,2010:2944,2009:2540,2008:2422,2007:2156,2006:1834},
        "Â§ßËøû": {2025:10002,2024:9517,2023:8753,2022:8431,2021:7826,2020:7030,2019:7002,2018:7668,2017:7364,2016:6810,2015:7732,2014:7656,2013:7651,2012:7003,2011:6151,2010:5158,2009:4350,2008:3858,2007:3131,2006:2570}
    };

    const timeline = {
        2006: ["‰∏äÊµ∑"], 2007: ["Âåó‰∫¨"], 2010: ["ÂπøÂ∑û"], 
        2011: ["Ê∑±Âú≥", "ÈáçÂ∫Ü", "ËãèÂ∑û"], 2013: ["Â§©Ê¥•"], 
        2014: ["Ê≠¶Ê±â", "ÊàêÈÉΩ"], 2015: ["Êù≠Â∑û"],
        2016: ["Âçó‰∫¨", "ÈùíÂ≤õ"], 2017: ["ÈïøÊ≤ô", "Êó†Èî°"], 
        2018: ["ÂÆÅÊ≥¢", "ÈÉëÂ∑û"], 2019: ["‰ΩõÂ±±"], 
        2020: ["Ê≥âÂ∑û", "ÊµéÂçó", "ÂêàËÇ•", "ÂçóÈÄö", "Á¶èÂ∑û", "Ë•øÂÆâ"],
        2021: ["‰∏úËéû"], 2023: ["Â∏∏Â∑û", "ÁÉüÂè∞"],
        2024: ["ÂîêÂ±±"], 2025: ["Ê∏©Â∑û", "Â§ßËøû"]
    };
    
    const activeYears = Object.keys(timeline).map(Number).sort((a,b)=>a-b);
    const yearColors = ['#F44336', '#2196F3', '#4CAF50', '#FFC107', '#9C27B0', '#FF5722', '#00BCD4', '#E91E63'];

    // --- ÂÖ®Â±ÄÂèòÈáè ---
    const LOGIC_W = 750;
    const LOGIC_H = 1500; 
    const stageContainer = document.getElementById('game-stage');
    const hitboxLayer = document.getElementById('hitbox-layer');
    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');
    
    const uiYear = document.getElementById('year-display');
    const uiCount = document.getElementById('count-num');
    const btnToggle = document.getElementById('btn-toggle');
    const btnShare = document.getElementById('btn-share');
    const toast = document.getElementById('toast');
    const modalOverlay = document.getElementById('modal-overlay');
    const modalTitle = document.getElementById('m-title');
    const modalSubtitle = document.getElementById('m-subtitle');
    
    let myChart = null;
    let cars = [];
    let separators = [];
    let currentYearIndex = 0;
    let currentYear = activeYears[0];
    let yearTimer = 0;
    const YEAR_DURATION = 2500; 
    let roadScroll = 0;
    const ROAD_SPEED = 8;
    
    let isPaused = false;
    let isFinished = false;

    // Â∏ÉÂ±ÄÂèÇÊï∞ (Ëá™ÈÄÇÂ∫î)
    const LANE_COUNT = 6;
    let w, h, dpr;
    let roadW, roadLeft, laneWidth, carWidth, carHeight, fontSize;
    let cameraScale = 1;

    // --- 1. Ê†∏ÂøÉÔºöËá™ÈÄÇÂ∫îÂàÜËæ®Áéá ---
    function resize() {
        dpr = window.devicePixelRatio || 1;
        w = window.innerWidth;
        h = window.innerHeight;
        
        canvas.width = w * dpr;
        canvas.height = h * dpr;
        
        roadW = w * 0.96;
        roadLeft = (w - roadW) / 2;
        laneWidth = roadW / LANE_COUNT;
        
        carWidth = laneWidth * 0.55; 
        carHeight = carWidth * 1.6; 
        fontSize = Math.floor(carWidth * 0.45);
        
        if(myChart) myChart.resize();
    }
    window.addEventListener('resize', resize);
    resize(); 

    // Canvas ÂúÜËßí
    CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
        if (w < 2 * r) r = w / 2;
        if (h < 2 * r) r = h / 2;
        this.beginPath();
        this.moveTo(x + r, y);
        this.arcTo(x + w, y, x + w, y + h, r);
        this.arcTo(x + w, y + h, x, y + h, r);
        this.arcTo(x, y + h, x, y, r);
        this.arcTo(x, y, x + w, y, r);
        this.closePath();
        return this;
    }

    class Car {
        constructor(name, foundYear, index) {
            this.name = name;
            this.foundYear = foundYear;
            this.color = yearColors[foundYear % yearColors.length];
            this.width = carWidth;
            this.height = carHeight;
            this.x = 0; this.y = 0; 
            this.targetX = 0; this.targetY = 0;
            this.driftPhase = Math.random() * Math.PI * 2;
            this.hasSpawned = false;

            this.hitbox = document.createElement('div');
            this.hitbox.className = 'car-hitbox';
            
            const handleInteract = (e) => {
                e.stopPropagation();
                e.preventDefault(); 
                if(!isFinished) {
                    showToast("ÊØîËµõËøõË°å‰∏≠...ËØ∑Á≠âÂæÖÁªìÊùü");
                } else {
                    openChart(this.name);
                }
            };

            this.hitbox.onclick = handleInteract;
            this.hitbox.ontouchend = handleInteract;
            hitboxLayer.appendChild(this.hitbox);
        }

        update(rankIndex, startY) {
            this.width = carWidth;
            this.height = carHeight;

            const row = Math.floor(rankIndex / LANE_COUNT);
            const col = rankIndex % LANE_COUNT;
            this.targetX = roadLeft + col * laneWidth + (laneWidth - this.width)/2;
            const rowGap = this.height * 1.5; 
            this.targetY = startY + row * rowGap;

            if(!this.hasSpawned) {
                this.x = this.targetX;
                this.y = this.targetY + (h / cameraScale) + 300; 
                this.hasSpawned = true;
            }

            this.x += (this.targetX - this.x) * 0.1;
            this.y += (this.targetY - this.y) * 0.08;
            this.currentDrift = Math.sin(Date.now()/250 + this.driftPhase) * 2;

            const centerX = w / 2;
            const finalX = (this.x + this.currentDrift - centerX) * cameraScale + centerX;
            const finalY = this.y * cameraScale;
            
            this.hitbox.style.width = (this.width * cameraScale) + 'px';
            this.hitbox.style.height = (this.height * cameraScale) + 'px';
            this.hitbox.style.transform = `translate(${finalX}px, ${finalY}px)`;
        }

        draw(ctx) {
            const x = this.x + this.currentDrift;
            const y = this.y;
            
            if(isFinished) {
                ctx.strokeStyle = "#FFFF00"; ctx.lineWidth = 4;
                ctx.strokeRect(x-2, y-2, this.width+4, this.height+4);
            }

            ctx.fillStyle = "rgba(0,0,0,0.4)";
            ctx.fillRect(x + this.width*0.15, y + this.width*0.15, this.width, this.height);
            ctx.fillStyle = "#111";
            const wW = this.width*0.18, wH = this.height*0.22;
            ctx.fillRect(x-wW/2, y+wH/2, wW, wH); ctx.fillRect(x+this.width-wW/2, y+wH/2, wW, wH);
            ctx.fillRect(x-wW/2, y+this.height-wH*1.5, wW, wH); ctx.fillRect(x+this.width-wW/2, y+this.height-wH*1.5, wW, wH);
            ctx.fillStyle = this.color;
            ctx.fillRect(x, y, this.width, this.height);
            ctx.fillStyle = "#283593";
            ctx.fillRect(x+this.width*0.1, y+this.height*0.18, this.width*0.8, this.height*0.2);
            ctx.fillStyle = "rgba(0,0,0,0.25)";
            ctx.fillRect(x+this.width*0.05, y+this.height*0.82, this.width*0.9, this.height*0.12);
            
            ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillStyle = "#fff";
            ctx.shadowColor="rgba(0,0,0,0.5)"; ctx.shadowBlur=0; ctx.shadowOffsetX=2; ctx.shadowOffsetY=2;
            const textYStart = y + this.height * 0.52;
            const textGap = fontSize * 1.1;
            ctx.fillText(this.name[0], x+this.width/2, textYStart);
            if(this.name[1]) ctx.fillText(this.name[1], x+this.width/2, textYStart+textGap);
            ctx.shadowColor="transparent";
        }
    }

    function gameLoop() {
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0); 
        ctx.clearRect(0, 0, w, h);

        // „Äê‰øÆÊîπÁÇπ„ÄëÈ°∂ÈÉ®ÁïôÁôΩÂ¢ûÂä†Âà∞ 25%ÔºåÈò≤Ê≠¢ÈÅÆÊå°
        const topMargin = h * 0.25; 
        const rowGap = carHeight * 1.5;
        const groupGap = rowGap * 1.2;
        const bottomPadding = h * 0.25;

        const oldCars = cars.filter(c => c.foundYear < currentYear);
        const newCars = cars.filter(c => c.foundYear === currentYear);
        const oldRows = Math.ceil(Math.max(oldCars.length, 0) / LANE_COUNT);
        const newRows = Math.ceil(Math.max(newCars.length, 0) / LANE_COUNT);
        
        let newCarsStartY = topMargin;
        if(oldCars.length > 0) {
            newCarsStartY = topMargin + oldRows * rowGap + groupGap;
            separators = [{ y: topMargin + oldRows * rowGap + groupGap/2 - 20, year: currentYear }];
        } else {
            separators = [];
        }

        let totalH = newCarsStartY;
        if (newCars.length > 0) {
            totalH += (newRows - 1) * rowGap + carHeight; 
        } else if (oldCars.length > 0) {
            totalH = topMargin + (oldRows - 1) * rowGap + carHeight;
        }
        totalH += bottomPadding;

        let targetScale = totalH > h ? h / totalH : 1;
        targetScale = Math.max(targetScale, 0.4); 
        cameraScale += (targetScale - cameraScale) * 0.1;

        const centerX = w / 2;
        ctx.translate(centerX, 0);
        ctx.scale(cameraScale, cameraScale);
        ctx.translate(-centerX, 0);

        const drawH = h / cameraScale;
        ctx.fillStyle = "#555"; ctx.fillRect(roadLeft, 0, roadW, drawH);
        if(!isPaused && !isFinished) roadScroll = (roadScroll + ROAD_SPEED) % 80;
        ctx.fillStyle = "#EEE"; const bW = roadW*0.02;
        ctx.fillRect(roadLeft-bW, 0, bW, drawH); ctx.fillRect(roadLeft+roadW, 0, bW, drawH);
        ctx.fillStyle = "rgba(255,255,255,0.4)";
        for(let i=1; i<LANE_COUNT; i++) {
            let lx = roadLeft + i*laneWidth;
            for(let y=-80; y<drawH; y+=80) ctx.fillRect(lx-2, y+roadScroll, 4, 40);
        }

        separators.forEach(sep => {
            const y = sep.y;
            ctx.save(); ctx.translate(w/2, y);
            const color = yearColors[sep.year % yearColors.length];
            ctx.beginPath(); ctx.setLineDash([10,10]); ctx.moveTo(-roadW*0.45, 0); ctx.lineTo(roadW*0.45, 0);
            ctx.strokeStyle = color; ctx.lineWidth = 4; ctx.stroke();
            const lw = fontSize*7, lh = fontSize*1.8;
            ctx.fillStyle = color; 
            ctx.beginPath(); ctx.roundRect(-lw/2, -lh/2, lw, lh, lh/2); ctx.fill();
            ctx.fillStyle = "#fff"; ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(sep.year + "Âπ¥Êñ∞Â¢û", 0, 2);
            ctx.restore();
        });

        if(!isPaused && !isFinished) {
            yearTimer += 16;
            if(yearTimer > YEAR_DURATION) {
                if(currentYearIndex < activeYears.length - 1) {
                    yearTimer = 0;
                    currentYearIndex++;
                    currentYear = activeYears[currentYearIndex];
                    uiYear.innerText = currentYear;
                    timeline[currentYear].forEach(name => {
                        cars.push(new Car(name, currentYear, cars.length));
                    });
                    uiCount.innerText = cars.length;
                } else {
                    if(yearTimer > 500) {
                        isFinished = true;
                        btnToggle.innerText = "ÈáçÊí≠";
                        btnToggle.classList.add('btn-replay');
                        showToast("üèÅ ÁªüËÆ°ÁªìÊùüÔºÅËØ∑ÁÇπÂáªËΩ¶ËæÜÊü•ÁúãËØ¶ÊÉÖ");
                    }
                }
            }
        }

        oldCars.sort((a,b) => a.foundYear - b.foundYear || a.originalIndex - b.originalIndex);
        oldCars.forEach((car, i) => { 
            car.update(i, topMargin); 
            car.draw(ctx); 
        });

        newCars.sort((a,b) => a.originalIndex - b.originalIndex);
        newCars.forEach((car, i) => { 
            car.update(i, newCarsStartY); 
            car.draw(ctx); 
        });

        requestAnimationFrame(gameLoop);
    }

    function openChart(name) {
        isPaused = true;
        modalTitle.innerText = "2006-2025 " + name + " GDPÂèòÂåñ";
        modalSubtitle.innerText = "Âçï‰ΩçÔºö‰∫øÂÖÉ‰∫∫Ê∞ëÂ∏Å";
        modalOverlay.style.display = "flex";
        
        const dom = document.getElementById('echarts-dom');
        if(!myChart) { myChart = echarts.init(dom); }
        
        const data = gdpData[name];
        if(!data) return;
        
        const years = Object.keys(data).sort((a,b)=>a-b);
        const values = years.map(y => data[y]);
        
        const option = {
            tooltip: { trigger: 'axis', formatter: '{b}Âπ¥: {c}‰∫øÂÖÉ' },
            grid: { top: 40, right: 20, bottom: 20, left: 50, containLabel: true },
            xAxis: { type: 'category', data: years, axisLabel: { interval: 3 } },
            yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed' } } },
            series: [{
                data: values, type: 'line', smooth: true, showSymbol: false, // ÈöêËóèÈªòËÆ§ÂúÜÁÇπ
                itemStyle: { color: '#4CAF50' },
                markLine: {
                    symbol: 'none',
                    label: { position: 'insideEndTop', formatter: '‰∏á‰∫ø', color: '#FF5722' },
                    lineStyle: { color: '#FF5722', type: 'dashed', width: 2 },
                    data: [ { yAxis: 10000 } ]
                },
                // ÂéªÊéâ label: { show: true }Ôºå‰øùÊåÅÁîªÈù¢Êï¥Ê¥Å
                areaStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        { offset: 0, color: 'rgba(76, 175, 80, 0.5)' },
                        { offset: 1, color: 'rgba(76, 175, 80, 0)' }
                    ])
                }
            }]
        };
        myChart.setOption(option);
        myChart.resize();
    }

    document.getElementById('modal-close').onclick = () => { modalOverlay.style.display = "none"; };

    btnToggle.onclick = () => {
        if(isFinished) {
            cars.forEach(c => hitboxLayer.removeChild(c.hitbox));
            cars = [];
            currentYearIndex = 0; currentYear = activeYears[0];
            yearTimer = 0; isFinished = false; isPaused = false;
            uiYear.innerText = currentYear; uiCount.innerText = 1;
            btnToggle.innerText = "ÊöÇÂÅú"; btnToggle.classList.remove('btn-replay');
            timeline[currentYear].forEach(name => cars.push(new Car(name, currentYear, cars.length)));
        } else {
            isPaused = !isPaused;
            btnToggle.innerText = isPaused ? "ÁªßÁª≠" : "ÊöÇÂÅú";
        }
    };

    function showToast(msg) {
        toast.innerText = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    btnShare.onclick = () => {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => showToast("ÈìæÊé•Â∑≤Â§çÂà∂"));
    };

    timeline[currentYear].forEach(name => cars.push(new Car(name, currentYear, cars.length)));
    gameLoop();

</script>
</body>
</html>
